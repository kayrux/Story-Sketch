let stories = [
  {
    name: "jess",
    title: "Jess's Adventure in the Enchanted Forest",
    pages: [
      {
        text: "Once upon a time, in a peaceful village, there lived a curious girl named Jess. She had a heart full of wonder and a head full of questions.",
        img: "",
      },
      {
        text: "One sunny morning, Jess decided to explore the mysterious Enchanted Forest that everyone in her village talked about. She packed a small picnic basket and set off on her journey.",
        img: "",
      },
      {
        text: "As she ventured deeper into the forest, the trees seemed to whisper secrets, and the flowers danced to the tune of the wind. Jess felt like she was in a magical world.",
        img: "",
      },
      {
        text: "She encountered talking animals, made friends with fairies, and even helped a lost gnome find his way home. Jess's day in the Enchanted Forest was filled with laughter and kindness.",
        img: "",
      },
      {
        text: "As the sun began to set, Jess realized it was time to return home. With a heart full of joy and stories to share, she headed back to her village, promising to visit the Enchanted Forest again.",
        img: "",
      },
      {
        text: "And so, Jess's adventure in the Enchanted Forest became a cherished memory, reminding her that the world is a magical place if you have a heart full of wonder.",
        img: "",
      },
    ],
  },
  {
    name: "Winston",
    title: "Winston: The Hero of Metroville",
    pages: [
      {
        text: "In the heart of a bustling metropolis known as Metroville, there lived an ordinary young man named Winston. He resided in a world of skyscrapers and city lights, where the pace of life was as fast as the subway trains that crisscrossed the city.",
        img: "",
      },
      {
        text: "But Winston was destined for an extraordinary journey. One fateful day, he discovered a hidden power within himself - the power to become a superhero. With newfound abilities, he joined forces with other remarkable heroes in Metroville to protect their beloved city from a formidable supervillain threat.",
        img: "",
      },
      {
        text: "Winston's superhero friends were a diverse group, each possessing unique talents. There was Captain Thunder, whose thunderous roars could shake buildings, Laserbeam Girl, who could emit beams of energy from her hands, and Techno-Wizard, a genius with gadgets and technology beyond imagination.",
        img: "",
      },
      {
        text: "The supervillain posed a grave danger to Metroville, and it would take all the combined powers and teamwork of Winston and his friends to defeat this menacing adversary. They devised clever strategies and used their distinct abilities to outsmart the supervillain at every turn.",
        img: "",
      },
      {
        text: "However, the battle was not without its challenges. They faced several close calls, and the supervillain proved to be a formidable foe. But Winston and his friends knew that they had to stay united, for it was their unwavering determination and cooperation that would ultimately save Metroville from destruction.",
        img: "",
      },
      {
        text: "Once the supervillain was defeated and Metroville was safe, Winston continued to protect the city from any new threats that emerged. But he didn't stop there. He used his incredible abilities to help the community and make the city a better place for all its inhabitants.",
        img: "",
      },
      {
        text: "Whether it was rescuing kittens from trees, assisting firefighters during emergencies, or simply spreading kindness throughout the city, Winston showed that being a hero meant more than just defeating supervillains. It meant making a positive impact on the lives of those around him.",
        img: "",
      },
      {
        text: "And so, Winston became a symbol of hope and inspiration in Metroville, a reminder that even in the busiest of cities, heroes could emerge from the most unexpected places, and they could change the world, one heroic act at a time.",
        img: "",
      },
    ],
  },
  {
    name: "Nick",
    title: "Nick's Adventure in the Enchanted Forest",
    pages: [
      {
        text: "In a world far removed from the bustling cities and sleepy towns, there existed a young boy named Nick. Nick wasn't your typical young adventurer; he lived in a treehouse high above the forest floor, nestled deep within the heart of the Enchanted Forest.",
        img: "",
      },
      {
        text: "Nick's treehouse was a magical place, surrounded by ancient trees that whispered secrets to the wind and fireflies that lit up the night. From his leafy perch, Nick had a view of the entire forest, which was filled with mysteries and wonders waiting to be discovered.",
        img: "",
      },
      {
        text: "One day, as Nick was exploring the depths of the Enchanted Forest, he stumbled upon a hidden treasure. But this was no ordinary treasure; it was guarded by talking animals, each with their own unique abilities and personalities.",
        img: "",
      },
      {
        text: "Nick knew he couldn't face this challenge alone, so he enlisted the help of his friends who called the Enchanted Forest their home. His companions included a wise owl, a mischievous squirrel, and a brave rabbit, each with their own special qualities that would prove invaluable on their quest.",
        img: "",
      },
      {
        text: "To outsmart the talking animals guarding the treasure, Nick and his friends used the power of teamwork and kindness. They shared stories and laughter, offered their help when needed, and slowly but surely, the talking animals became their allies.",
        img: "",
      },
      {
        text: "Through this journey, Nick and his friends learned a valuable lesson - that cooperation and kindness can open doors that were once locked. With the help of their newfound animal friends, they successfully claimed the hidden treasure as their own.",
        img: "",
      },
      {
        text: "But the story didn't end there. Instead of keeping the treasure for themselves, Nick and his friends decided to use it for the greater good of the Enchanted Forest. They improved the forest's beauty, helped its magical creatures, and shared the treasure's benefits with all who called the forest home.",
        img: "",
      },
      {
        text: "As time passed, the Enchanted Forest became an even more magical place, and Nick and his friends continued to explore its wonders and protect its secrets. The hidden treasure had not only brought them good fortune but had also made the Enchanted Forest an even more enchanting and harmonious place to live.",
        img: "",
      },
      {
        text: "And so, Nick's adventure in the Enchanted Forest became a legend, a tale of friendship, cooperation, and the transformative power of kindness, reminding all who heard it that magic truly exists in the world, and it can be found in the most unexpected places.",
        img: "",
      },
    ],
  },
];

// let stories = [
//   {
//     title: "Dino's Adventure: The Magical Tree of Leaves",
//     tags: ["trees", "dinosaurs", "leaves"],
//     frontPage: "",
//     pages: [
//       {
//         text: "Once upon a time, in a magical land filled with colorful dinosaurs and towering trees, there lived a young and curious dinosaur named Dino...",
//         img: "",
//       },
//       {
//         text: "One sunny morning, Dino decided to embark on an exciting adventure to find the legendary 'Magical Tree of Leaves.' According to the ancient tales, this tree had the most beautiful and colorful leaves that held incredible powers...",
//         img: "",
//       },
//       {
//         text: "As Dino journeyed through the forest, he met his friends along the way—a wise Triceratops named Tria and a playful Pterodactyl named Pete...",
//         img: "",
//       },
//       {
//         text: "Through the dense forest and across bubbling streams, they searched for clues that would lead them to the magical tree. Suddenly, they stumbled upon a hidden path filled with colorful flowers and sparkling rocks...",
//         img: "",
//       },
//       {
//         text: "Following the path, they reached a clearing where an enormous tree stood, covered in leaves of every hue imaginable...",
//         img: "",
//       },
//       {
//         text: "Excited and in awe, they approached the tree, and as they touched the leaves, something extraordinary happened. The leaves whispered ancient tales and secrets, filling their hearts with wonder and joy...",
//         img: "",
//       },
//       {
//         text: "Dino, Tria, and Pete learned that the magical leaves could grant a wish to anyone with a kind and pure heart. Overwhelmed with joy, they each made a wish—to spread love, kindness, and happiness throughout their forest and beyond...",
//         img: "",
//       },
//       {
//         text: "As they made their wishes, the tree sprinkled a dust of magic over them, sealing their promises to the forest and its creatures...",
//         img: "",
//       },
//       {
//         text: "Their journey back was filled with laughter and excitement as they shared their newfound knowledge with fellow dinosaurs...",
//         img: "",
//       },
//       {
//         text: "And so, in the heart of the enchanting forest, Dino and his friends continued to spread love and kindness, making their world a better place for all dinosaurs, trees, and leaves, leaving a lasting legacy for generations to come.",
//         img: "",
//       },
//     ],
//   },
//   {
//     title: "The Adventure of Sammy the Snail",
//     pages: [
//       {
//         text: "Once upon a time, in a magical garden, lived a curious snail named Sammy. Sammy was unlike any other snail in the garden. Sammy had a dream - a dream to see the world beyond the garden.",
//         img: "",
//       },
//       {
//         text: "Sammy spent his days exploring the garden, talking to the wise old trees and friendly ladybugs. One day, while chatting with a butterfly named Bella, Sammy shared his dream of adventure.",
//         img: "",
//       },
//       {
//         text: "Bella said, 'Why don't you go on an adventure right here in the garden? There's so much to discover and learn!' Sammy thought this was a splendid idea and set off on his very first adventure.",
//         img: "",
//       },
//       {
//         text: "Sammy discovered a hidden trail behind the flower bushes. He followed it and found a secret garden with magical glowing flowers. 'Wow!' Sammy exclaimed, mesmerized by the beauty.",
//         img: "",
//       },
//       {
//         text: "In this magical garden, Sammy met a wise old snail named Grandpa Sheldon. Grandpa Sheldon shared stories of his own adventures and gave Sammy a special amulet that would guide him on his journey.",
//         img: "",
//       },
//       {
//         text: "With the amulet around his neck, Sammy felt a burst of courage. He embarked on a grand adventure, meeting friendly creatures and overcoming challenges. He realized that even small creatures like him could have big adventures.",
//         img: "",
//       },
//       {
//         text: "Sammy returned to his garden, filled with excitement and new stories to tell. He knew that his dream of adventure had come true, right in his own backyard.",
//         img: "",
//       },
//       {
//         text: "And so, Sammy the Snail continued to have many more exciting adventures in the garden, sharing his tales with all his friends, and inspiring them to dream big too.",
//         img: "",
//       },
//     ],
//   },
// ];

const storedStoriesJSON = localStorage.getItem("stories");
let isVoiceMuted = true;

// If stories exists in local storage, retrieve the data use it.
// Otherwise use the hardcoded stories and save it to local storage
if (storedStoriesJSON) {
  // Parse the JSON string back into a JavaScript object
  retrievedStories = JSON.parse(storedStoriesJSON);
  if (stories.length <= retrievedStories.length) {
    console.log("Setting to retrieved stories");
    stories = retrievedStories;
  } else {
    console.log("Setting to database stories");
    localStorage.setItem("stories", JSON.stringify(stories));
  }
  console.log("Stories retrieved", stories);
} else {
  console.log("No stories found in local storage. Adding stories...");
  // Convert the stories object to JSON
  const storiesJSON = JSON.stringify(stories);

  // Save the JSON string to local storage under the key 'stories'
  localStorage.setItem("stories", storiesJSON);
}

const storiesContainer = document.getElementById("stories-container");

function createStoryCard(story, index) {
  console.log(index);
  const storyCard = document.createElement("div");
  storyCard.classList.add("story-card");

  const title = document.createElement("div");
  title.classList.add("book-title");
  title.textContent = story.title;

  const bookOuter = document.createElement("div");
  bookOuter.classList.add("book-outer");
  const book = document.createElement("div");
  book.classList.add("book");
  bookOuter.appendChild(book);

  book.addEventListener("click", () => {
    window.location.href = "story.html?storyIndex=" + index;
  });

  if (story.pages[0].img) {
    image = new Image();
    image.onload = function () {
      book.style.backgroundImage = `url("${this.src}")`;
    };
    image.src = story.pages[0].img;
    console.log("setting background");
  }

  storyCard.appendChild(title);
  storyCard.appendChild(bookOuter);

  return storyCard;
}

function populateStories() {
  let i = 0;
  for (const story of stories) {
    const storyCard = createStoryCard(story, i);
    storiesContainer.appendChild(storyCard);
    i++;
  }
}

// Call the function to populate the stories
populateStories();

const chatPrompts = {
  jess: [
    {
      question:
        "Where does Jess live? Is it in a big city, a small town, or maybe in a magical forest?",
      answer: "She lives in a new planet made of candy",
    },
    {
      question:
        "What is the most amazing adventure or quest that Jess goes on in the candy planet? Is there a special mission or something magical that happens to her?",
      answer: "There's a problem with cavities",
    },
    {
      question:
        "Who are Jess's friends on this candy planet? Do they have any special abilities or qualities that could help them solve the problem of cavities?",
      answer: "She has a gingerbread friend named Ginger",
    },
    {
      question:
        "How does Ginger help Jess and their friends tackle the problem of cavities in the candy planet? Does Ginger have any special skills or ideas to share?",
      answer: "He knows the way to a dentist",
    },
    {
      question:
        "What challenges or obstacles do they face on their journey to find a dentist in the candy planet? Are there any fun or exciting moments along the way?",
      answer: "They see different candy on different planets",
    },
  ],
  nick: [
    {
      question:
        "Where does Nick live? Is it in a big city, a small town, or maybe in a magical forest?",
      answer: "He lives in a treehouse in the enchanted forest",
    },
    {
      question:
        "What is the most amazing adventure or quest that Nick goes on in the enchanted forest? Is there a special mission or something magical that happens to him?",
      answer: "He discovers a hidden treasure guarded by talking animals",
    },
    {
      question:
        "Who are Nick's friends in the enchanted forest? Do they have any special abilities or qualities that could help them find the hidden treasure?",
      answer:
        "His friends are a wise owl, a mischievous squirrel, and a brave rabbit",
    },
    {
      question:
        "How do Nick and his friends outsmart the talking animals and claim the hidden treasure as their own? Do they learn any valuable lessons along the way?",
      answer:
        "They use teamwork and kindness to befriend the animals, and they learn that cooperation is the key to success",
    },
    {
      question:
        "What happens to the hidden treasure once Nick and his friends have it? Does it bring good fortune or unexpected challenges?",
      answer:
        "They use the treasure to improve the enchanted forest and share its benefits with all the magical creatures",
    },
  ],
  winston: [
    {
      question:
        "Where does Winston live? Is it in a big city, a small town, or maybe in a magical forest?",
      answer: "He lives in a bustling big city called Metroville",
    },
    {
      question:
        "What is the most amazing adventure or quest that Winston goes on in Metroville? Is there a special mission or something extraordinary that happens to him?",
      answer:
        "He becomes a superhero and joins forces with other heroes to save the city from a supervillain",
    },
    {
      question:
        "Who are Winston's superhero friends in Metroville? Do they have unique superpowers or gadgets that help them in their mission?",
      answer:
        "His friends are Captain Thunder, Laserbeam Girl, and Techno-Wizard, each with their own incredible abilities",
    },
    {
      question:
        "How do Winston and his superhero friends defeat the supervillain and save Metroville from destruction? Do they face any unexpected challenges along the way?",
      answer:
        "They combine their powers and use teamwork to outsmart the supervillain, but they face several close calls and must stay united",
    },
    {
      question:
        "What does Winston do when there are no supervillains to defeat? Does he use his powers for good in other ways, or does he face new challenges in his everyday life?",
      answer:
        "Winston continues to protect Metroville from threats, but he also uses his abilities to help the community and make the city a better place",
    },
  ],
};

const synth = window.speechSynthesis; // Initialize the speech synthesis

let currentPromptIndex = 0;
let isStoryDisplayed = false;
let isNameSet = false; // To track if the user's name has been set

let topActionBarElement = document.getElementById("top-action-bar");
let userInputElement = document.getElementById("user-input");

// Execute a function when the user presses a key on the keyboard
userInputElement.addEventListener("keypress", function (event) {
  // If the user presses the "Enter" key on the keyboard
  if (event.key === "Enter") {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    handleUserInput();
  }
});

// Function to display chat messages
function displayMessages() {
  const chatContainer = document.getElementById("chat-container");

  if (!isNameSet) {
    // Display the initial bot message to ask for the user's name
    const initialBotMessage = document.createElement("div");
    initialBotMessage.classList.add("message", "bot");
    initialBotMessage.innerText =
      "Bot: Welcome! Let's create a story together. I'll ask you questions, and you can provide answers. First, please tell me your name (Jess, Nick, or Winston):";
    chatContainer.appendChild(initialBotMessage);

    // Read the initial message aloud
    readAloud(
      "Welcome! Let's create a story together. I'll ask you questions, and you can provide answers. First, please tell me your name (Jess, Nick, or Winston):"
    );

    return;
  }

  // Display the first bot question
  const firstPrompt = chatPrompts.jess[currentPromptIndex];
  const botMessageElement = document.createElement("div");
  botMessageElement.classList.add("message", "bot");
  botMessageElement.innerText = firstPrompt.question;
  chatContainer.appendChild(botMessageElement);

  // Read the first question aloud
  readAloud(firstPrompt.question);
}

// Function to read text aloud
function readAloud(text) {
  if (!isMuted) {
    const utterance = new SpeechSynthesisUtterance(text);
    const typingGif = document.getElementById("typing-gif");

    // Show the typing GIF while speaking
    typingGif.style.display = "inline";

    synth.speak(utterance);

    utterance.onend = function () {
      // Hide the typing GIF when speech synthesis is done
      typingGif.style.display = "none";
    };
  }
}

// Function to handle user input
function handleUserInput() {
  const userInput = document.getElementById("user-input").value;
  const chatContainer = document.getElementById("chat-container");

  if (isStoryDisplayed) {
    // If the story is already displayed, tell the user to try again
    const errorMessageElement = document.createElement("div");
    errorMessageElement.classList.add("message", "bot");
    errorMessageElement.innerText =
      "Bot: Please try again or continue the story.";
    chatContainer.appendChild(errorMessageElement);
    readAloud("Please try again or continue the story.");

    // Clear the input field
    document.getElementById("user-input").value = "";

    return;
  }

  if (userInput) {
    // Display user message
    const userMessageElement = document.createElement("div");
    userMessageElement.classList.add("message", "user");
    userMessageElement.innerText = `You: ${userInput}`;
    chatContainer.appendChild(userMessageElement);

    if (!isNameSet) {
      // Check if the user input is one of the accepted names
      const name = userInput.toLowerCase();
      if (name === "jess" || name === "nick" || name === "winston") {
        // Set the name and proceed to the next question set
        isNameSet = true;
        currentCharacter = name; // Set the current character
      } else {
        // Ask for the name again if it's not recognized
        const errorMessageElement = document.createElement("div");
        errorMessageElement.classList.add("message", "bot");
        errorMessageElement.innerText =
          "Bot: Please choose a valid name (Jess, Nick, or Winston).";
        chatContainer.appendChild(errorMessageElement);
        readAloud("Please choose a valid name (Jess, Nick, or Winston).");
      }
    }
    if (!isNameSet) {
      // Clear the input field
      document.getElementById("user-input").value = "";

      // Smoothly scroll to the bottom of the chat container
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return;
    }
    if (currentPromptIndex < chatPrompts.jess.length) {
      // Display the next bot prompt based on the chosen name
      const name = isNameSet ? currentCharacter.toLowerCase() : "jess";
      const nextPrompt = chatPrompts[name][currentPromptIndex];
      const botMessageElement = document.createElement("div");
      botMessageElement.classList.add("message", "bot");
      botMessageElement.innerText = nextPrompt.question;
      chatContainer.appendChild(botMessageElement);
      readAloud(nextPrompt.question);
      currentPromptIndex++;
    } else {
      // All prompts answered, display the story
      isStoryDisplayed = true;
      displayStory();
    }

    // Clear the input field
    document.getElementById("user-input").value = "";

    // Smoothly scroll to the bottom of the chat container
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
}
let selectedStoryIndex = 0;
function displayStory() {
  const chatContainer = document.getElementById("chat-container");
  // const currentCharacter = document.getElementById("user-input").value.toLowerCase();
  let storyContent = "";
  let characterFound = false;

  let i = 0;
  stories.forEach((story) => {
    if (story.name.toLowerCase().includes(currentCharacter)) {
      characterFound = true;
      storyContent = story.pages.map((page) => page.text).join("\n\n");
      selectedStoryIndex = i;
    }
    i++;
  });

  if (!characterFound) {
    storyContent = "Sorry, we couldn't find a story for that character.";
  }

  const storyMessageElement = document.createElement("div");
  storyMessageElement.classList.add("message", "bot");
  storyMessageElement.innerHTML = `Bot: ${storyContent}`;
  chatContainer.appendChild(storyMessageElement);

  readAloud(storyContent);

  const continueButton = document.getElementById("continue-button");
  continueButton.style.display = "inline";

  chatContainer.scrollTop = chatContainer.scrollHeight;
  const goToStoryButton = document.getElementById("go-to-story-button");
  goToStoryButton.style.display = "block"; // Change to "inline" if needed
}

function goToStoryPage() {
  window.location.href = `story.html?storyIndex=${selectedStoryIndex}`;
}

// Initialize a variable to track the voice state
//let isVoiceMuted = false;
let isMuted = JSON.parse(localStorage.getItem("muted")) || false;
// Track whether speech synthesis is muted
initializeMuteBtnInnerHTML();

// Function to toggle voice mute/unmute
function toggleVoice() {
  const voiceButton = document.getElementById("voice-button");
  if (isVoiceMuted) {
    // Unmute the voice
    // synth.resume();
    isMuted = false;
    voiceButton.textContent = "Mute";
  } else {
    // Mute the voice
    isMuted = true;
    // synth.pause();
    // synth.cancel();
    voiceButton.textContent = "Unmute";
  }

  // Toggle the voice state
  isVoiceMuted = !isVoiceMuted;
}

//
//const synth = window.speechSynthesis; // Initialize the speech synthesis

function initializeMuteBtnInnerHTML() {
  if (!isMuted) {
    document.getElementById("voice-button").innerHTML =
      '<i id="sound-icon" class="fa fa-volume-off" aria-hidden="true"></i> Mute';
  } else {
    document.getElementById("voice-button").innerHTML =
      '<i id="sound-icon" class="fa fa-volume-up" aria-hidden="true"></i> Unmute';
  }
}
// Function to toggle mute/unmute
function toggleMute() {
  if (isMuted) {
    // Unmute speech synthesis
    synth.resume();
    isMuted = false;
    document.getElementById("voice-button").innerHTML =
      '<i id="sound-icon" class="fa fa-volume-off" aria-hidden="true"></i> Mute';
    localStorage.setItem("muted", JSON.stringify(isMuted));
  } else {
    // Mute speech synthesis
    synth.cancel(); // Stop any ongoing speech
    isMuted = true;
    document.getElementById("voice-button").innerHTML =
      '<i id="sound-icon" class="fa fa-volume-up" aria-hidden="true"></i> Unmute';
    localStorage.setItem("muted", JSON.stringify(isMuted));
  }
}

// Add a click event listener to the "Turn Off Voice" button
document.getElementById("voice-button").addEventListener("click", toggleMute);

//

// Function to continue the video
function continueVideo() {
  const video = document.getElementById("video");
  const chatContainer = document.getElementById("chat-container");
  const continueButton = document.getElementById("continue-button");
  const botCharacter = document.getElementById("bot-character");
  const userInput = document.getElementById("user-input");
  const submitButton = document.getElementById("submit-button");
  const typingGif = document.getElementById("typing-gif");
  const storyGenerationContainer = document.getElementById(
    "story-generation-container"
  );

  if (video.style.display === "block") {
    video.pause();
    video.style.display = "none";
    chatContainer.style.display = "block";
    botCharacter.style.display = "block";
    submitButton.style.display = "block";
    userInput.style.display = "block";
    typingGif.style.display = "block";
    topActionBarElement.style.display = "flex";
    // Change button text to "See Video" and pause the video if needed
    continueButton.innerText = "Meet Robby";
    storyGenerationContainer.style.columnGap = "2rem";
  } else {
    // Show the video and change button text to "Close"
    video.style.display = "block";
    chatContainer.style.display = "none";
    botCharacter.style.display = "none";
    submitButton.style.display = "none";
    userInput.style.display = "none";
    typingGif.style.display = "none";
    topActionBarElement.style.display = "none";
    video.play(); // Play the video
    continueButton.innerText = "Close"; // Change button text to "Close"
    storyGenerationContainer.style.columnGap = "0rem";
  }
}

// Call the function to display chat messages
// added code below for the stories container.
displayMessages();
